<!DOCTYPE html>
<html>
<head>
  <title>chapatt-web-widget-tk - Specimen Sheet</title>

  <link rel="stylesheet" type="text/css" href="chapatt-web-widget-tk/example.css" />

  <script type="text/javascript" src="chapatt-web-widget-tk/chapatt-web-widget-tk.js"></script>

  <script type="text/javascript" src="getEmPixels/getEmPixels.min.js"></script>

  <script type="text/javascript">
    function referenceTaperRout(rRef, rRefTaper, rRefCurve, x) {
        if (rRefCurve) {
            var r = (Math.pow(rRefTaper, 2) - (2 * rRefTaper) + 1) / Math.pow(rRefTaper, 2);
            return (rRef / (r - 1)) * (Math.pow(r, x)) - (rRef / (r - 1));
        } else {
            if (x < 0.5)
                return rRef * ((rRefTaper / 0.5) * x);
            else
                return rRef * ((((1 - rRefTaper) / 0.5) * x) + (rRefTaper - (1 - rRefTaper)));
        }
    }
    function referenceTaperRin(rRef, x) {
        return rRef;
    }
    function referenceTaperVout(rRef, rRefTaper, rRefCurve, x) {
        var rout = referenceTaperRout(rRef, rRefTaper, rRefCurve, x);
        var rin = rRef;
        return rout / rin;
    }
    function myTaperRout(rPot, rTaper1, rTaper2, x) {
        return 1 / ((1 / (rPot * x)) + (1 / rTaper1));
    }
    function myTaperRin(rPot, rTaper1, rTaper2, x) {
        return (1 / ((1 / (rPot * (1 - x))) + (1 / rTaper2))) +
            myTaperRout(rPot, rTaper1, rTaper2, x);
    }
    function myTaperVout(rPot, rTaper1, rTaper2, x) {
        rout = myTaperRout(rPot, rTaper1, rTaper2, x);
        rin = myTaperRin(rPot, rTaper1, rTaper2, x);
        return rout / rin;
    }

    document.addEventListener('DOMContentLoaded', function() {
        function plot(fns, cursorX) {
            var canvas = document.getElementById('chart');
            var ctx = canvas.getContext('2d');
            var chartProperties = {};

            chartProperties.marginTop = 50;
            chartProperties.marginRight = 220;
            chartProperties.marginBottom = 50;
            chartProperties.marginLeft = 50;
            chartProperties.plotX0 = chartProperties.marginLeft;
            chartProperties.plotXMax = canvas.width - chartProperties.marginRight;
            chartProperties.w = chartProperties.plotXMax - chartProperties.plotX0;
            chartProperties.plotY0 = canvas.height - chartProperties.marginBottom;
            chartProperties.plotYMax = chartProperties.marginTop;
            chartProperties.h = chartProperties.plotY0 - chartProperties.plotYMax;

            chartProperties.plotXScale = chartProperties.w;

            chartProperties.plotYScaleNames = [];
            chartProperties.fnsIndicesByPlotYScale = []; // parallel to plotYScaleNames
            fns.forEach(function(item, index) {
                if (chartProperties.plotYScaleNames.includes(item.yScale)) {
                    chartProperties.fnsIndicesByPlotYScale[chartProperties.plotYScaleNames.indexOf(item.yScale)].push(index);
                } else {
                    chartProperties.plotYScaleNames.push(item.yScale);
                    chartProperties.fnsIndicesByPlotYScale[chartProperties.plotYScaleNames.indexOf(item.yScale)] = [];
                    chartProperties.fnsIndicesByPlotYScale[chartProperties.plotYScaleNames.indexOf(item.yScale)].push(index);
                }
            });

            // parallel to fns
            chartProperties.fnsPoints = fns.map(function(item) {
                var points = [];

                for (var i=1; chartProperties.plotX0 + i <= chartProperties.plotXMax; ++i) {
                    points.push(item.fn(i / chartProperties.plotXScale));
                }

                return points;
            });

            // parallel to fns
            chartProperties.fnsMax = chartProperties.fnsPoints.map(function(item) {
                return Math.max.apply(null, item);
            });

            chartProperties.fnsMaxByPlotYScale = chartProperties.fnsIndicesByPlotYScale.map(function(item) {
                var fnsMaxYScale = [];

                item.forEach(function(item) {
                    fnsMaxYScale.push(chartProperties.fnsMax[item]);
                });

                return fnsMaxYScale;
            });

            // parallel to plotYScaleNames
            chartProperties.plotYScales = chartProperties.fnsMaxByPlotYScale.map(function(item) {
                return chartProperties.h / Math.max.apply(null, item); 
            });

            chartProperties.cursorLineWidth = 1;
            chartProperties.graphLineWidth = 2;
            chartProperties.fontSize = getEmPixels();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            plotAxes(ctx, chartProperties, 'Fraction of Full Rotation', 'Resistance');
            plotFns(ctx, chartProperties, fns);
            var cursorLegend = plotCursor(ctx, chartProperties, fns, cursorX, chartProperties.fontSize);
            plotKey(ctx, chartProperties, fns, cursorLegend[3][1] + chartProperties.fontSize);
        }

        function plotKey(ctx, chartProperties, fns, legendPlotY) {
            var legendData = {
                linesBySection: []
            };

            function drawLineSymbol(color, dash, lineWidth, ctx, chartProperties, x, y) {
                ctx.beginPath();
                ctx.moveTo(x - (chartProperties.fontSize / 2), y);
                ctx.lineTo(x + (chartProperties.fontSize / 2), y);
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.setLineDash(dash);
                ctx.stroke();
            }

            chartProperties.fnsIndicesByPlotYScale.forEach(function(item, yScaleI, array) {
                legendData.linesBySection.push([]);

                item.forEach(function(fnsIndex, fnI) {
                    var text = fns[fnsIndex].name;

                    var color = fns[fnsIndex].color; 
                    var dash = fns[fnsIndex].dash;
                    var lineWidth = fns[fnsIndex].lineWidth;
                    var symbolDrawingFn = drawLineSymbol.bind(null, color, dash, lineWidth);

                    legendData.linesBySection[yScaleI].push({
                        symbolDrawingFn: symbolDrawingFn, text: text
                    });
                });
            });

            return plotLegend(ctx, chartProperties, legendPlotY, legendData);
        }

        function plotLegend(ctx, chartProperties, legendPlotY, legendData) {
            ctx.save();

            var fontSize = chartProperties.fontSize;
            var lineSpacing = fontSize;
            var left = chartProperties.plotXMax + 10;
            var padding = fontSize / 2;

            if (legendData.linesBySection.length === 0) {
                var boxCoords = [];
                for (var i=0; i < 4; ++i)
                    boxCoords.push([chartProperties.plotXMax + 10, legendPlotY]);
                return boxCoords;
            }

            ctx.font = fontSize.toString() + 'px sans-serif';
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.lineWidth = chartProperties.graphLineWidth;
            var maxLineWidth = 0;
            var blockPlotY;

            var hLineYs = [legendPlotY];

            /*
             * Register title block bottom border
             */
            if (legendData.title) {
                blockPlotY = legendPlotY + padding;

                var text = legendData.title;
                var textWidth = ctx.measureText(text).width;
                if (textWidth > maxLineWidth) {
                    maxLineWidth = textWidth;
                }

                hLineYs.push(blockPlotY + fontSize + padding);
            }

            legendData.linesBySection.forEach(function(section, sectionI, array) {
                var prevItemLen = sectionI ?
                    array[sectionI - 1].length :
                    0;

                section.forEach(function(line, lineI) {
                    blockPlotY = legendPlotY + padding + ((prevItemLen + lineI) * lineSpacing) + (sectionI ? padding * 2 : 0) + (legendData.title ? (padding * 2) + fontSize : 0);

                    // Draw text
                    var text = line.text;
                    ctx.fillStyle = 'rgb(0, 0, 0)';
                    ctx.fillText(text, left + padding + (1.5 * fontSize), blockPlotY);
                    var textWidth = ctx.measureText(text).width;
                    if ((lineWidth = textWidth + (fontSize * 1.5)) > maxLineWidth) {
                        maxLineWidth = lineWidth;
                    }

                    // Draw symbol
                    var x = left + padding + (fontSize / 2);
                    var y = Math.round(blockPlotY + (fontSize / 2));
                    line.symbolDrawingFn(ctx, chartProperties, x, y);
                });

                hLineYs.push(blockPlotY + fontSize + padding);
            });

            /*
             * Draw title
             */
            if (legendData.title) {
                blockPlotY = legendPlotY + padding;

                var text = legendData.title;
                ctx.textAlign = "center";
                ctx.fillStyle = 'rgb(0, 0, 0)';
                ctx.fillText(text,
                             left + ((padding + maxLineWidth + padding) / 2),
                             blockPlotY
                );
            }

            /* box corner coordinates top-left, top-right, bottom-right, bottom-left */
            var boxCoords = [];
            boxCoords.push([left, hLineYs[0]]);
            boxCoords.push([left + padding + maxLineWidth + padding, hLineYs[0]]);
            boxCoords.push([left + padding + maxLineWidth + padding, hLineYs[hLineYs.length - 1]]);
            boxCoords.push([left, hLineYs[hLineYs.length - 1]]);

            /* Draw box */
            ctx.beginPath();
            boxCoords.forEach(function(item, index) {
                if (index == 0)
                    ctx.moveTo.apply(ctx, item);
                else
                    ctx.lineTo.apply(ctx, item);
            });
            ctx.closePath();
            ctx.strokeStyle = 'rgb(0, 0, 0)'; 
            ctx.setLineDash([0, 0]);
            ctx.stroke();

            /* Draw horizontal separators */
            for (var i=1; i < hLineYs.length - 1; ++i) {
                ctx.beginPath();
                ctx.moveTo(left, hLineYs[i]);
                ctx.lineTo(left + padding + maxLineWidth + padding, hLineYs[i]);
                ctx.strokeStyle = 'rgb(0, 0, 0)'; 
                ctx.setLineDash([0, 0]);
                ctx.stroke();
            }

            ctx.restore();

            return boxCoords;
        }

        function plotCursor(ctx, chartProperties, fns, cursorX, legendPlotY) {
            ctx.save();

            function roundToDecimalPlaces(x, places) {
                var roundScale = Math.pow(10, places);
                return Math.round(roundScale * x) / roundScale;
            }

            var cursorPointRadius = 4;
            var cursorPlotX = chartProperties.plotX0 + (chartProperties.w * cursorX);
            var cursorPlotYs = [];
            fns.forEach(function(item) {
               cursorPlotYs.push(chartProperties.plotY0 - (chartProperties.plotYScales[chartProperties.plotYScaleNames.indexOf(item.yScale)] * item.fn(cursorX)));
            });
            var cursorPlotYMax = Math.min.apply(null, cursorPlotYs);

            ctx.strokeStyle = 'rgb(200, 200, 200)'; 
            ctx.lineWidth = chartProperties.cursorLineWidth;

            // draw horizontal lines
            cursorPlotYs.forEach(function(item) {
                ctx.beginPath();
                ctx.moveTo(chartProperties.plotX0, item);
                ctx.lineTo(cursorPlotX, item);
                ctx.stroke();
            });

            // draw vertical line
            ctx.beginPath();
            ctx.moveTo(cursorPlotX, chartProperties.plotY0);
            ctx.lineTo(cursorPlotX, cursorPlotYMax);
            ctx.stroke();

            // draw points
            cursorPlotYs.forEach(function(item, index) {
                ctx.beginPath();
                ctx.fillStyle = fns[index].color;
                ctx.arc(cursorPlotX, item, cursorPointRadius, 0, 2 * Math.PI, false);
                ctx.fillStyle = fns[index].pointFill;
                ctx.fill();
                ctx.strokeStyle = fns[index].color; 
                ctx.lineWidth = chartProperties.graphLineWidth;
                ctx.setLineDash(fns[index].pointDash);
                ctx.stroke();
            });

            var fontSize = chartProperties.fontSize;
            var lineSpacing = fontSize;
            var left = chartProperties.plotXMax + 10;

            // draw legend
            var legendData = {
                title: 'x = ' + Math.round(cursorX * 100) + '%',
                linesBySection: []
            };

            function drawPointSymbol(color, fill, dash, lineWidth, ctx, chartProperties, x, y) {
                ctx.beginPath();
                ctx.arc(x, y, cursorPointRadius, 0, 2 * Math.PI, false);
                ctx.fillStyle = fill;
                ctx.fill();
                ctx.strokeStyle = color; 
                ctx.setLineDash(dash);
                ctx.stroke();
            }

            chartProperties.fnsIndicesByPlotYScale.forEach(function(item, yScaleI, array) {
                legendData.linesBySection.push([]);

                item.forEach(function(fnsIndex, fnI) {
                    var text = roundToDecimalPlaces(fns[fnsIndex].unit.convTo(fns[fnsIndex].fn(cursorX)), 1) + ' ' + fns[fnsIndex].unit.symbol +
                        (fns[fnsIndex].plotCursorPercentage != false ?
                            ' (' + Math.round(fns[fnsIndex].fn(cursorX) / chartProperties.fnsMax[fnsIndex] * 100) + '%)' :
                            '')

                    var color = fns[fnsIndex].color;
                    var fill = fns[fnsIndex].pointFill;
                    var dash = fns[fnsIndex].pointDash;
                    var lineWidth = fns[fnsIndex].lineWidth;
                    var symbolDrawingFn = drawPointSymbol.bind(null, color, fill, dash, lineWidth);

                    legendData.linesBySection[yScaleI].push({
                        symbolDrawingFn: symbolDrawingFn, text: text
                    });
                });

            });

            ctx.restore();

            return plotLegend(ctx, chartProperties, legendPlotY, legendData);
        }

        function plotFns(ctx, chartProperties, fns) {
            ctx.save();

            fns.forEach(function(item, index) {
                var yScale = chartProperties.plotYScales[chartProperties.plotYScaleNames.indexOf(item.yScale)];

                ctx.beginPath();
                ctx.moveTo(chartProperties.plotX0,
                    chartProperties.plotY0 - (yScale * (item.fn(0))));

                for (var i = 1; chartProperties.plotX0 + i <= chartProperties.plotXMax; ++i) {
                    ctx.lineTo(chartProperties.plotX0 + i,
                        chartProperties.plotY0 - (yScale * chartProperties.fnsPoints[index][i]));
                }

                ctx.strokeStyle = item.color;
                ctx.lineWidth = item.lineWidth;
                ctx.setLineDash(item.dash);
                ctx.stroke();
            });

            ctx.restore();
        }

        function plotAxes(ctx, chartProperties, xLabel, yLabel) {
            ctx.save();

            ctx.beginPath();
            ctx.strokeStyle = 'rgb(0, 0, 0)'; 
            ctx.lineWidth = 2;

            // draw axes
                       // miter properly with cursor
            ctx.moveTo(chartProperties.plotXMax + (chartProperties.cursorLineWidth / 2),
                       // completely outside chart
                       chartProperties.plotY0 + (ctx.lineWidth / 2));
                       // completely outside chart
            ctx.lineTo(chartProperties.plotX0 - (ctx.lineWidth / 2),
                       // miter properly with other axis
                       chartProperties.plotY0 + (ctx.lineWidth / 2));
                       // completely outside chart
            ctx.lineTo(chartProperties.plotX0 - (ctx.lineWidth / 2),
                       // miter properly with cursor
                       chartProperties.plotYMax - (chartProperties.cursorLineWidth / 2));

            ctx.stroke();

            var fontSize = chartProperties.fontSize;
            var axisLabelMargin = 10;
            ctx.font = fontSize.toString() + 'px sans-serif';
            ctx.textAlign = "center";
            ctx.fillStyle = 'rgb(0, 0, 0)';

            // draw x axis label
            ctx.fillText(xLabel, chartProperties.plotX0 + (chartProperties.w / 2), chartProperties.plotY0 + fontSize + axisLabelMargin);

            ctx.save();
            ctx.rotate(-Math.PI / 2);
            // draw y axis label
            ctx.fillText(yLabel, -chartProperties.plotYMax - (chartProperties.h / 2), chartProperties.marginLeft - axisLabelMargin);
            ctx.restore();

            ctx.restore();
        }

        function plotShuntedPot(vars) {
            var fns = [];
            if (vars.plotFunctions[1] === 'selected') {
                fns.push({
                    fn: referenceTaperRout.bind(null, vars.rRef, vars.rRefTaper, vars.rRefCurve),
                    name: 'Reference Rout',
                    color: 'rgb(0, 255, 0)',
                    pointFill: 'rgb(255, 255, 255)',
                    dash: [5, 5],
                    pointDash: [],
                    lineWidth: 2,
                    yScale: 'scale0',
                    unit: vars.rUnit
                },
                {
                    fn: myTaperRout.bind(null, vars.rPot, vars.rTaper1, vars.rTaper2),
                    name: 'Shunted Rout',
                    color: 'rgb(0, 0, 255)',
                    pointFill: 'rgb(255, 255, 255)',
                    dash: [5, 5],
                    pointDash: [],
                    lineWidth: 2,
                    yScale: 'scale0',
                    unit: vars.rUnit
                });
            }
            if (vars.plotFunctions[2] === 'selected') {
                fns.push({
                    fn: referenceTaperRin.bind(null, vars.rRef),
                    name: 'Reference Rin',
                    color: 'rgb(0, 255, 0)',
                    pointFill: 'rgb(255, 255, 255)',
                    dash: [2, 2],
                    pointDash: [3, 3],
                    lineWidth: 2,
                    yScale: 'scale0',
                    unit: vars.rUnit
                },
                {
                    fn: myTaperRin.bind(null, vars.rPot, vars.rTaper1, vars.rTaper2),
                    name: 'Shunted Rin',
                    color: 'rgb(0, 0, 255)',
                    pointFill: 'rgb(255, 255, 255)',
                    dash: [2, 2],
                    pointDash: [3, 3],
                    lineWidth: 2,
                    yScale: 'scale0',
                    unit: vars.rUnit
                });
            }
            if (vars.plotFunctions[0] === 'selected') {
                fns.push({
                    fn: referenceTaperVout.bind(null, vars.rRef, vars.rRefTaper, vars.rRefCurve),
                    name: 'Reference Vout',
                    color: 'rgb(0, 255, 0)',
                    pointFill: 'rgb(0, 255, 0)',
                    dash: [],
                    pointDash: [],
                    lineWidth: 2,
                    yScale: 'scale1',
                    unit: vars.fracUnit,
                    plotCursorPercentage: false
                },
                {
                    fn: myTaperVout.bind(null, vars.rPot, vars.rTaper1, vars.rTaper2),
                    name: 'Shunted Vout',
                    color: 'rgb(0, 0, 255)',
                    pointFill: 'rgb(0, 0, 255)',
                    dash: [],
                    pointDash: [],
                    lineWidth: 2,
                    yScale: 'scale1',
                    unit: vars.fracUnit,
                    plotCursorPercentage: false
                });
            }

            if (vars.plotError == 'selected') {
                if (vars.plotFunctions[1] === 'selected') {
                    fns.push({
                        // Magnitude of error between Routs
                        fn: function(x) {
                            var mine = myTaperRout(vars.rPot, vars.rTaper1, vars.rTaper2, x);
                            var ref = referenceTaperRout(vars.rRef, vars.rRefTaper, vars.rRefCurve, x);
                            return Math.abs(mine - ref);
                        },
                        name: 'Rout Error',
                        color: 'rgb(255, 0, 0)',
                        pointFill: 'rgb(255, 255, 255)',
                        dash: [5, 5],
                        pointDash: [],
                        lineWidth: 2,
                        yScale: 'scale0',
                        unit: vars.rUnit,
                        plotCursorPercentage: false
                    });
                }
                if (vars.plotFunctions[2] === 'selected') {
                    fns.push({
                        // Magnitude of error between Rins
                        fn: function(x) {
                            var mine = myTaperRin(vars.rPot, vars.rTaper1, vars.rTaper2, x);
                            var ref = referenceTaperRin(vars.rRef, x);
                            return Math.abs(mine - ref);
                        },
                        name: 'Rin Error',
                        color: 'rgb(255, 0, 0)',
                        pointFill: 'rgb(255, 255, 255)',
                        dash: [2, 2],
                        pointDash: [3, 3],
                        lineWidth: 2,
                        yScale: 'scale0',
                        unit: vars.rUnit,
                        plotCursorPercentage: false
                    });
                }
                if (vars.plotFunctions[0] === 'selected') {
                    fns.push({
                        // Magnitude of error between Vouts
                        fn: function(x) {
                            var mine = myTaperVout(vars.rPot, vars.rTaper1, vars.rTaper2, x);
                            var ref = referenceTaperVout(vars.rRef, vars.rRefTaper, vars.rRefCurve, x);
                            return Math.abs(mine - ref);
                        },
                        name: 'Vout Error',
                        color: 'rgb(255, 0, 0)',
                        pointFill: 'rgb(255, 0, 0)',
                        dash: [],
                        pointDash: [],
                        lineWidth: 2,
                        yScale: 'scale1',
                        unit: vars.fracUnit,
                        plotCursorPercentage: false
                    });
                }
            }

            plot(fns, vars.cursorX);
        }

        function plotAuto(args) {
            var vars = {};

            vars.rRef = (args && ('rRef' in args)) ?
                args.rRef :
                spinBoxRRef.getValueModel().getValue();
            vars.rRefTaper = (args && ('rRefTaper' in args)) ?
                args.rRefTaper :
                sliderRRefTaper.getValueModel().getValue();
            vars.rPot = (args && ('rPot' in args)) ?
                args.rPot :
                spinBoxRPot.getValueModel().getValue();
            vars.rTaper1 = (args && ('rTaper1' in args)) ?
                args.rTaper1 :
                spinBoxRTaper1.getValueModel().getValue();
            vars.rTaper2 = (args && ('rTaper2' in args)) ?
                args.rTaper2 :
                spinBoxRTaper2.getValueModel().getValue();
            vars.cursorX = (args && ('cursorX' in args)) ?
                args.cursorX :
                sliderCursorX.getValueModel().getValue();
            vars.autoReplot = (args && ('autoReplot' in args)) ?
                args.autoReplot :
                ((toggleButtonAutoReplot.getValueModel().getValue() == 'selected') ?
                    true :
                    false);
            vars.plot = (args && ('plot' in args)) ? args.plot : false;
            vars.fitROut = (args && ('fitROut' in args)) ? args.fitROut : false;
            vars.plotError = (args && ('plotError' in args)) ?
                args.plotError :
                toggleButtonPlotError.getValueModel().getValue();
            vars.constraints = (args && ('constraints' in args)) ?
                args.constraints :
                toggleButtonGroupConstraints.getValueModel().getValue();
            vars.plotFunctions = (args && ('plotFunctions' in args)) ?
                args.plotFunctions :
                toggleButtonGroupPlotFunctions.getValueModel().getValue();
            vars.rRefCurve = (((args && ('rRefCurve' in args)) ?
                args.rRefCurve :
                toggleButtonRRefCurve.getValueModel().getValue()) === 'selected') ?
                    true :
                    false;

            var rModel = spinBoxRTaper1.getValueModel();
            vars.rUnit = rModel.getUnitTable()[rModel.getUnitIndex()];
            var fracModel = sliderRRefTaper.getValueModel();
            vars.fracUnit = fracModel.getUnitTable()[fracModel.getUnitIndex()];

            /*
             * Constrain Vout to Rref Taper
             * solve for whichever variable you want to generate
             * vOut = (1 / ((1 / rTaper1) + (1 / (rPot / 2)))) / ((1 / ((1 / rTaper1) + (1 / (rPot / 2)))) + (1 / ((1 / rTaper2) + (1 / (rPot / 2)))))
             */
            var callbackObj;
            if (vars.constraints[0] === 'selected') {
                if (vars.rRefTaper > 0.5) {
                    vars.rTaper1 = Infinity;
                    callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                    spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                    spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                    if (args && 'rTaper2' in args) {
                        vars.rPot = ((2 - (4 * vars.rRefTaper)) * vars.rTaper2) / (vars.rRefTaper - 1);
                        callbackObj = spinBoxRPot.getValueModel().signalDisconnect('valueChanged', rPotCallback);
                        spinBoxRPot.getValueModel().setValue(vars.rPot);
                        spinBoxRPot.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    } else {
                        vars.rTaper2 = (vars.rPot - (vars.rRefTaper * vars.rPot)) / ((4 * vars.rRefTaper) - 2);
                        callbackObj = spinBoxRTaper2.getValueModel().signalDisconnect('valueChanged', rTaper2Callback);
                        spinBoxRTaper2.getValueModel().setValue(vars.rTaper2);
                        spinBoxRTaper2.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    }
                } else if (vars.rRefTaper < 0.5) {
                    vars.rTaper2 = Infinity;
                    callbackObj = spinBoxRTaper2.getValueModel().signalDisconnect('valueChanged', rTaper2Callback);
                    spinBoxRTaper2.getValueModel().setValue(vars.rTaper2);
                    spinBoxRTaper2.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                    if (args && 'rTaper1' in args) {
                        vars.rPot = ((2 - (4 * vars.rRefTaper)) * vars.rTaper1) / vars.rRefTaper;
                        callbackObj = spinBoxRPot.getValueModel().signalDisconnect('valueChanged', rPotCallback);
                        spinBoxRPot.getValueModel().setValue(vars.rPot);
                        spinBoxRPot.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    } else {
                        vars.rTaper1 = (vars.rRefTaper * vars.rPot) / (2 - (4 * vars.rRefTaper));
                        callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                        spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                        spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    }
                } else if (vars.rRefTaper = 0.5) {
                    vars.rTaper1 = Infinity;
                    callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                    spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                    spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                    vars.rTaper2 = Infinity;
                    callbackObj = spinBoxRTaper2.getValueModel().signalDisconnect('valueChanged', rTaper2Callback);
                    spinBoxRTaper2.getValueModel().setValue(vars.rTaper2);
                    spinBoxRTaper2.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                }
            }

            /*
             * Constrain Rout to Rref Taper
             * solve for whichever variable you want to generate
             * 1 / ((1 / (rPot / 2)) + (1 / rTaper1)) = rRefTaper * (1 / ((1 / rPot) + (1 / rTaper1)))
             */
            callbackObj = {};
            if (vars.constraints[1] === 'selected') {
                vars.rTaper2 = Infinity;
                callbackObj = spinBoxRTaper2.getValueModel().signalDisconnect('valueChanged', rTaper2Callback);
                spinBoxRTaper2.getValueModel().setValue(vars.rTaper2);
                spinBoxRTaper2.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                if (vars.rRefTaper > 0.5) {
                    if (args && 'rTaper1' in args) {
                        vars.rPot = (vars.rTaper1 - (2 * vars.rRefTaper * vars.rTaper1)) / (vars.rRefTaper - 1);
                        callbackObj = spinBoxRPot.getValueModel().signalDisconnect('valueChanged', rPotCallback);
                        spinBoxRPot.getValueModel().setValue(vars.rPot);
                        spinBoxRPot.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    } else {
                        vars.rTaper1 = (vars.rPot - (vars.rRefTaper * vars.rPot)) / ((2 * vars.rRefTaper) - 1);
                        callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                        spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                        spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                    }
                } else {
                    vars.rTaper1 = Infinity;
                    callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                    spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                    spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                }
            }

            /*
             * Fit Shunted Rout to Reference Rout
             * solve for whichever variable you want to generate
             * rRef * rRefTaper = 1 / ((1 / (rPot / 2)) + (1 / rTaper1))
             * rRef = 1 / ((1 / rPot) + (1 / rTaper1))
             */
            callbackObj = {};
            if (vars.fitROut) {
                vars.rTaper2 = Infinity;
                callbackObj = spinBoxRTaper2.getValueModel().signalDisconnect('valueChanged', rTaper2Callback);
                spinBoxRTaper2.getValueModel().setValue(vars.rTaper2);
                spinBoxRTaper2.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                if (vars.rRefTaper > 0.5) {
                        vars.rPot = -(vars.rRef * vars.rRefTaper) / (vars.rRefTaper - 1);
                        callbackObj = spinBoxRPot.getValueModel().signalDisconnect('valueChanged', rPotCallback);
                        spinBoxRPot.getValueModel().setValue(vars.rPot);
                        spinBoxRPot.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);

                        vars.rTaper1 = (vars.rRef * vars.rRefTaper) / ((2 * vars.rRefTaper) - 1);
                        callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                        spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                        spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                } else {
                    vars.rTaper1 = Infinity;
                    callbackObj = spinBoxRTaper1.getValueModel().signalDisconnect('valueChanged', rTaper1Callback);
                    spinBoxRTaper1.getValueModel().setValue(vars.rTaper1);
                    spinBoxRTaper1.getValueModel().signalConnect('valueChanged', callbackObj.callback, callbackObj.userData);
                }
            }

            if (vars.autoReplot || vars.plot)
                plotShuntedPot(vars);
        }

        /*
         * Plot Button
         */
        var buttonPlot = chapatt.Button.new(document.getElementById('button-plot'), 1);
        buttonPlot.signalConnect('clicked', function() {
            plotAuto({plot: true});
        });

        /*
         * Auto-Replot ToggleButton
         */
        var toggleButtonAutoReplot = chapatt.ToggleButton.new(document.getElementById('toggle-button-auto-replot'));
        toggleButtonAutoReplot.getValueModel().signalConnect('valueChanged',
            function(targetWidget, signalName, signalData, userData) {
                if (signalData == 'selected')
                    plotAuto({autoReplot: true});
            }
        );

        /*
         * Plot Functions ToggleButtonGroup
         */
        var toggleButtonGroupPlotFunctions = chapatt.ToggleButtonGroup.new(document.getElementById('toggle-button-group-plot-functions'));
        toggleButtonGroupPlotFunctions.getValueModel().signalConnect('valueChanged',
            function(targetWidget, signalName, signalData, userData) {
                plotAuto({plotFunctions: signalData});
            }
        );

        /*
         * Plot Error ToggleButton
         */
        var toggleButtonPlotError = chapatt.ToggleButton.new(document.getElementById('toggle-button-plot-error'));
        toggleButtonPlotError.getValueModel().signalConnect('valueChanged',
            function(targetWidget, signalName, signalData, userData) {
                plotAuto({plotError: signalData});
            }
        );


        var fractionUnits = [
            chapatt.Unit.new('fraction', 'frac', identity, identity),
            chapatt.Unit.new('percent', '%',
                function(valueAsThis) {
                    return valueAsThis / 100;
                },
                function(valueAsDefault) {
                    return valueAsDefault * 100;
                }
            )
        ];
        /*
         * Cursor X Coordinate Slider
         */
        var sliderCursorX = chapatt.Slider.new(document.getElementById('slider-cursor-x'), fractionUnits, 0, 1);
        sliderCursorX.getValueModel().signalConnect('valueChanged', function(targetWidget, signalName, signalData, userData) {
            plotAuto({cursorX: signalData});
        });


        function identity(obj) {
            return obj;
        }
        var resistanceUnits = [
            chapatt.Unit.new('ohm', 'R', identity, identity),
            chapatt.Unit.new('kilohm', 'k',
                function(valueAsThis) {
                    return valueAsThis * 1000;
                },
                function(valueAsDefault) {
                    return valueAsDefault / 1000;
                }
            ),
            chapatt.Unit.new('megaohm', 'M',
                function(valueAsThis) {
                    return valueAsThis * 1000000;
                },
                function(valueAsDefault) {
                    return valueAsDefault / 1000000;
                }
            )
        ];
        /*
         * Rpot SpinBox
         */
        var spinBoxRPot = chapatt.SpinBox.new(document.getElementById('spin-box-r-pot'), resistanceUnits);
        Object.assign(spinBoxRPot.getValueModel(), chapatt.Bounded);
        spinBoxRPot.getValueModel().setMinimum(0);
        spinBoxRPot.getValueModel().setMaximum(Infinity);
        function rPotCallback(targetWidget, signalName, signalData, userData) {
            plotAuto({rPot: signalData});
        }
        spinBoxRPot.getValueModel().signalConnect('valueChanged', rPotCallback);

        /*
         * Rtaper1 SpinBox
         */
        var spinBoxRTaper1 = chapatt.SpinBox.new(document.getElementById('spin-box-r-taper-1'), resistanceUnits);
        Object.assign(spinBoxRTaper1.getValueModel(), chapatt.Bounded);
        spinBoxRTaper1.getValueModel().setMinimum(0);
        spinBoxRTaper1.getValueModel().setMaximum(Infinity);
        function rTaper1Callback(targetWidget, signalName, signalData, userData) {
            plotAuto({rTaper1: signalData});
        }
        spinBoxRTaper1.getValueModel().signalConnect('valueChanged', rTaper1Callback);

        /*
         * Rtaper2 SpinBox
         */
        var spinBoxRTaper2 = chapatt.SpinBox.new(document.getElementById('spin-box-r-taper-2'), resistanceUnits);
        Object.assign(spinBoxRTaper2.getValueModel(), chapatt.Bounded);
        spinBoxRTaper2.getValueModel().setMinimum(0);
        spinBoxRTaper2.getValueModel().setMaximum(Infinity);
        function rTaper2Callback(targetWidget, signalName, signalData, userData) {
                plotAuto({rTaper2: signalData});
        }
        spinBoxRTaper2.getValueModel().signalConnect('valueChanged', rTaper2Callback);

        /*
         * Constraints ToggleButtonGroup
         */
        var toggleButtonGroupConstraints = chapatt.ToggleButtonGroup.new(document.getElementById('toggle-button-group-constraints'));
        toggleButtonGroupConstraints.getValueModel().signalConnect('valueChanged',
            function(targetWidget, signalName, signalData, userData) {
                plotAuto({constraints: signalData});
            }
        );

        /*
         * Fit Rout Button
         */
        var buttonFitROut = chapatt.Button.new(document.getElementById('button-fit-rout'), 1);
        buttonFitROut.signalConnect('clicked', function() {
            plotAuto({fitROut: true});
        });

        /*
         * Rref SpinBox
         */
        var spinBoxRRef = chapatt.SpinBox.new(document.getElementById('spin-box-r-ref'), resistanceUnits);
        Object.assign(spinBoxRRef.getValueModel(), chapatt.Bounded);
        spinBoxRRef.getValueModel().setMinimum(0);
        spinBoxRRef.getValueModel().setMaximum(Infinity);
        spinBoxRRef.getValueModel().signalConnect('valueChanged', function(targetWidget, signalName, signalData, userData) {
                plotAuto({rRef: signalData});
        });

        /*
         * Rref taper characteristic Slider
         */
        var sliderRRefTaper = chapatt.Slider.new(document.getElementById('slider-r-ref-taper'), fractionUnits, 0, 1);
        sliderRRefTaper.getValueModel().signalConnect('valueChanged', function(targetWidget, signalName, signalData, userData) {
            plotAuto({rRefTaper: signalData});
        });

        /*
         * Rref curve fitting ToggleButton
         */
        var toggleButtonRRefCurve = chapatt.ToggleButton.new(document.getElementById('toggle-button-rref-curve'));
        toggleButtonRRefCurve.getValueModel().signalConnect('valueChanged',
            function(targetWidget, signalName, signalData, userData) {
                plotAuto({rRefCurve: signalData});
            }
        );

        /*
         * Instructions help box
         */
        var helpBox = document.getElementById('instructions');
        var helpButton = helpBox.getElementsByClassName('button')[0];

        helpButton.addEventListener('click', function() {
            var helpBox = document.getElementById('instructions');
            var helpContent = helpBox.getElementsByClassName('content')[0];

            if (helpContent.style.display === 'none')
                helpContent.style.display = 'block';
            else
                helpContent.style.display = 'none';
        });

        plotAuto();
    });
  </script>

  <style type="text/css">
    /* disable font boosting */
    * {
      max-height: 9999999em;
    }

    body {
      font-size: 1em;
      font-family: sans-serif;
    }

    label {
      white-space: nowrap;
    }

    .help-box {
      font-size: 0.75em;
      margin-bottom: 0.5em;
    }

    .help-box > .button {
      border-bottom-style: dotted; 
      border-bottom-width: 2px; 
      border-bottom-color: #000000; 
      cursor: pointer;
    }

    .help-box > .content {
      margin: 0.5em 0 0 0;
    }

    .help-tooltip {
      font-size: 0.75em;
      border-bottom-style: dotted; 
      border-bottom-width: 2px; 
      border-bottom-color: #000000; 
    }

    #bibliography {
      font-size: 0.75em;
    }

    ol#bibliography {
      counter-reset: bibliography;
      padding-left: 2em;
    }

    ol#bibliography > li {
      list-style-type: none;
      text-indent: -2em;
      margin-bottom: 0.25em;
    }

    ol#bibliography > li:before {
      content: "[" counter(bibliography) "] ";
      counter-increment: bibliography;
    }
  </style>
</head>
<body>
  <h1>Shunted Potentiometer Calculator</h1>

  <canvas id="chart" width="800" height="550" style="display: block"></canvas>

  <div id="instructions" class="help-box">
    <span class="button" title="Click to show/hide help">Help</span>
    <p class="content" style="display: none;">To change value in spinboxes and sliders, click arrows, scroll mouse wheel with cursor over control, click control and drag cursor up or down, or type value in box and press enter or click elsewhere. Optionally append an SI prefix to values (It is case-sensitive, e.g. 'm' means mili, 'M' means mega. 'u' means micro. The base unit symbol may be left off). The last unit used will be assumed for unsuffixed entries, and the increase/decrease functionality is scaled appropriately.</p>
  </div>

  <div id="button-plot" class="example-widget example-button">
    <div>Plot</div>
  </div>

  <div id="toggle-button-auto-replot" class="example-widget example-button example-toggle-button selected">
    <span>Auto-Replot</span>
  </div>

  <ul id="toggle-button-group-plot-functions" class="example-widget example-button-group">
      <li class="example-button example-toggle-button button selected">
          <div>V<sub>out</sub></div>
      </li>
      <li class="example-button example-toggle-button button selected">
          <div>R<sub>out</sub></div>
      </li>
      <li class="example-button example-toggle-button button">
          <div>R<sub>in</sub></div>
      </li>
  </ul>

  <div id="toggle-button-plot-error" class="example-widget example-button example-toggle-button selected">
    <span>Plot Error</span>
  </div>

  <label>Cursor X
  <div id="slider-cursor-x" class="example-widget example-slider">
    <div class="bar" style="width: 50%;"></div>
    <div class="overlay">
      <div class="decrease">
        <div style="font-size: 0.6em;">&#x25c0;</div>
      </div>
      <div class="label">
        <div></div>
      </div>
      <div class="increase">
        <div style="font-size: 0.6em;">&#x25b6;</div>
      </div>
      <div class="field">
        <div contenteditable="true">50%</div>
      </div>
    </div>
  </div>
  </label>

  <br />

  <div style="border-style: solid; border-width: 2px; border-color: #0000ff; margin-bottom: 0.5em; padding: 0.5em;">
  <label>R<sub>pot</sub>
  <div id="spin-box-r-pot" class="example-widget example-spin-box">
    <div class="decrease">
      <div style="font-size: 0.6em;">&#x25c0;</div>
    </div>
    <div class="field">
      <div contenteditable="true">10k</div>
    </div>
    <div class="increase">
      <div style="font-size: 0.6em;">&#x25b6;</div>
    </div>
  </div>
  </label>

  <label>R<sub>taper1</sub>
  <div id="spin-box-r-taper-1" class="example-widget example-spin-box">
    <div class="decrease">
      <div style="font-size: 0.6em;">&#x25c0;</div>
    </div>
    <div class="field">
      <div contenteditable="true">2.2k</div>
    </div>
    <div class="increase">
      <div style="font-size: 0.6em;">&#x25b6;</div>
    </div>
  </div>
  </label>

  <label>R<sub>taper2</sub>
  <div id="spin-box-r-taper-2" class="example-widget example-spin-box">
    <div class="decrease">
      <div style="font-size: 0.6em;">&#x25c0;</div>
    </div>
    <div class="field">
      <div contenteditable="true">2.2k</div>
    </div>
    <div class="increase">
      <div style="font-size: 0.6em;">&#x25b6;</div>
    </div>
  </div>
  </label>

  <label>Constrain to R<sub>ref</sub> Taper
  <ul id="toggle-button-group-constraints" class="example-widget example-button-group">
      <li class="example-button example-toggle-button button">
          <div>V<sub>out</sub></div>
      </li>
      <li class="example-button example-toggle-button button">
          <div>R<sub>out</sub></div>
      </li>
  </ul>
  </lable>

  <div id="button-fit-rout" class="example-widget example-button">
    <div>Fit Shunted R<sub>out</sub> to Reference R<sub>out</sub></div>
  </div>
  </div>

  <div style="border-style: solid; border-width: 2px; border-color: #00ff00; margin-bottom: 0.5em; padding: 0.5em;">
  <label>R<sub>ref</sub>
  <div id="spin-box-r-ref" class="example-widget example-spin-box">
    <div class="decrease">
      <div style="font-size: 0.6em;">&#x25c0;</div>
    </div>
    <div class="field">
      <div contenteditable="true">1.6k</div>
    </div>
    <div class="increase">
      <div style="font-size: 0.6em;">&#x25b6;</div>
    </div>
  </div>
  </label>

  <label>Taper <span class="help-tooltip" title="Percent of maximum resistance at 50% rotation">(?)</span>
  <div id="slider-r-ref-taper" class="example-widget example-slider">
    <div class="bar" style="width: 80%;"></div>
    <div class="overlay">
      <div class="decrease">
        <div style="font-size: 0.6em;">&#x25c0;</div>
      </div>
      <div class="label">
        <div></div>
      </div>
      <div class="increase">
        <div style="font-size: 0.6em;">&#x25b6;</div>
      </div>
      <div class="field">
        <div contenteditable="true">80%</div>
      </div>
    </div>
  </div>
  </label>

  <div id="toggle-button-rref-curve" class="example-widget example-button example-toggle-button selected">
    <span>Fit Curve</span>
  </div>
  </div>

  <ol id="bibliography">
    <li>R. Keen, (1999). <em>The Secret Life of Pots</em> [Online]. Available: <a href="http://www.geofex.com/article_folders/potsecrets/potscret.htm">http://www.geofex.com/article_folders/potsecrets/potscret.htm</a></li>
    <li>R. Elliott, (2002, Jan. 22). <em>Beginners' Guide to Potentiometers</em> [Online]. Available: <a href="http://sound.whsites.net/pots.htm">http://sound.whsites.net/pots.htm</a></li>
    <li>R. Ives, "Characteristics of Shunted Potentiometers," <em>Audio</em>, February 1965, pp. 19-21, 1965 [Online]. Available: <a href="http://www.americanradiohistory.com/Archive-Audio/60s/Audio-1965-02.pdf">http://www.americanradiohistory.com/Archive-Audio/60s/Audio-1965-02.pdf</a></li>
  </ol>
</body>
</html>
